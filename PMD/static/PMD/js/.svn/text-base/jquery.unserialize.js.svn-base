(function($){
	$.fn.unserialize = function(serialized_form) {
		// Construct an associative array name->value
		// If there is more than 1 value for a name then value will be an array
		log("Unserialize:", serialized_form);
		var pairs = serialized_form.split("&");
		log("Pairs:", pairs);
		var unserialized_values = {};
		for (var i=0; i < pairs.length; i++)
		{
			var pair = pairs[i].split("=", 2);
			if(pair.length > 1)
			{
				//Decode the serialized_form
				pair[0] = decodeURIComponent(pair[0]).replace(/\+/g, " ");
				pair[1] = decodeURIComponent(pair[1]).replace(/\+/g, " ");
				
				if(unserialized_values.hasOwnProperty(pair[0]))
				{
					if(unserialized_values[pair[0]].constructor === Array)
					{
						unserialized_values[pair[0]].push(pair[1]);
					}
					else
					{
						unserialized_values[pair[0]] = [unserialized_values[pair[0]], pair[1]];
					}
				}
				else if(pair[0].indexOf("[]") > 0)
				{
					unserialized_values[pair[0]] = [pair[1]];
				}
				else
				{
					unserialized_values[pair[0]] = pair[1];
				}
			}
		}
		log("Unserialized values:", $.JSON.encode(unserialized_values));
		return this.each(function(){
			// First unselect all checkboxes/radio that are not disabled
			$("input:checked", this).not(":disabled").attr('checked', false);
			
			// Iterate through each input, select and textarea but not buttons, hidden and disabled; and set the value
			$("input,select,textarea", this).not(":button,:disabled,:hidden").each(function(){
				var elem = $(this);
				if(unserialized_values.hasOwnProperty(elem.attr("name")))
				{
					if(elem.is(":checkbox") && unserialized_values[elem.attr("name")].constructor !== Array )
					{
						elem.attr("checked", true);
					}
					else
					{
						elem.val(unserialized_values[elem.attr("name")]);
					}
					
				}
				else
				{
					if(elem.is(":checkbox"))
						elem.attr("checked", false);
					else
						elem.val("");
				}
			});
				
		});
	};
})(jQuery);
